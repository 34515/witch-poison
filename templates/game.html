<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¥³å·«çš„æ¯’è¯ â€”â€” åŒäººå¯¹å¼ˆ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>

  <!-- æœ¬åœ° Socket.IO å®¢æˆ·ç«¯ -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- CDN è„šæœ¬ï¼ˆå« SRI æ ¡éªŒï¼‰ -->
  <script
    src="https://cdn.socket.io/4.6.1/socket.io.min.js"
    integrity="sha384â€‘KA7mODwgQGmeRC6Xre3hJO+Zxpan0auVh4Czdqbg81DKJ3bZZYVmP+y4F31x4OL"
    crossorigin="anonymous">
  </script>
  <!-- å…œåº•ï¼šå¦‚æœ io ä»æœªå®šä¹‰ï¼Œå°±å†æ¬¡æ³¨å…¥æ—  SRI çš„ CDN -->
  <script>
    if (typeof io === 'undefined') {
      const fallback = document.createElement('script');
      fallback.src = 'https://cdn.socket.io/4.6.1/socket.io.min.js';
      document.head.appendChild(fallback);
    }
  </script>

  <style>
    html, body {
      height:100%; margin:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-start;
      font-family:"Segoe UI",system-ui;
      text-align:center; background:#f9f9f9;
    }
    h2 { margin:1rem 0; }
    #status { margin:.5rem 0 1rem; font-size:1rem; color:#333; }

    :root { --cell:6rem; --gap:4px; --border:3px; }
    #board {
      --cols:{{ board_size }};
      display:grid; place-items:center;
      background:#000; padding:var(--border);
      box-shadow:
        0 0 0 var(--border) #fff,
        0 0 0 calc(2*var(--border)) #000;
      margin-bottom:1rem;
    }
    #foodPool {
      display:grid; background:#fff;
      grid-template-columns:repeat(var(--cols),var(--cell));
      grid-auto-rows:var(--cell); gap:var(--gap);
    }
    #foodPool button {
      all:unset; cursor:pointer;
      width:100%; height:100%; font-size:2.4rem;
      display:flex; align-items:center; justify-content:center;
      box-sizing:border-box;
      box-shadow:
        inset var(--border) 0 0 #000,
        inset calc(-1*var(--border)) 0 0 #000,
        inset 0 var(--border) 0 #000,
        inset 0 calc(-1*var(--border)) 0 #000,
        inset calc(2*var(--border)) 0 0 #fff,
        inset calc(-2*var(--border)) 0 0 #fff,
        inset 0 calc(2*var(--border)) 0 #fff,
        inset 0 calc(-2*var(--border)) 0 #fff;
    }

    #overlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.6);
      display:none; align-items:center; justify-content:center;
      z-index:999;
    }
    #dialog {
      background:#fff; border-radius:12px;
      padding:1.6rem 2rem; min-width:16rem;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      position:relative; text-align:center;
    }
    #dialog h3 { margin:0 0 1rem; font-size:1.2rem; }
    #dialog .btn {
      padding:.5rem 1.2rem; font-size:1rem;
      background:#eee; border:2px solid #333;
      border-radius:6px; cursor:pointer;
    }
    #dialog .close {
      position:absolute; top:.5rem; right:.6rem;
      background:transparent; border:none;
      font-size:1.2rem; cursor:pointer;
    }
  </style>
</head>
<body>
  <h2>å¥³å·«çš„æ¯’è¯ â€”â€” åŒäººå¯¹å¼ˆ</h2>
  <p>
    æˆ¿é—´å·ï¼š<strong id="roomId">{{ room }}</strong>
    <button class="btn" onclick="navigator.clipboard.writeText('{{ room }}')">å¤åˆ¶</button>
  </p>
  <p>æ£‹ç›˜å°ºå¯¸ï¼š{{ board_size }} Ã— {{ board_size }}</p>
  <div id="status">æ­£åœ¨è¿æ¥â€¦</div>
  <div id="board"><div id="foodPool"></div></div>

  <div id="overlay" onclick="hideDialog(event)">
    <div id="dialog" onclick="event.stopPropagation()">
      <button class="close" onclick="hideDialog()">âœ–</button>
      <h3 id="dialogMsg">æç¤º</h3>
      <button id="dialogBtn" class="btn" style="display:none" onclick="location.href='/'">è¿”å›å¤§å…</button>
    </div>
  </div>

  <script>
    const statusTxt = document.getElementById('status'),
          pool      = document.getElementById('foodPool'),
          overlay   = document.getElementById('overlay'),
          dialogMsg = document.getElementById('dialogMsg'),
          dialogBtn = document.getElementById('dialogBtn');

    const room      = "{{ room }}",
          boardSize = {{ board_size }};
    document.documentElement.style.setProperty('--cols', boardSize);

    const animals = ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®'];
    let myIcon, oppIcon;
    ;(()=>{
      // é¡µé¢åŠ è½½æ—¶å…ˆåšä¸€æ¬¡éšæœºï¼Œä¹‹åä¼šè¢« update ä¸­è¦†ç›–
      const arr = animals.map(v=>[Math.random(),v])
                         .sort((a,b)=>a[0]-b[0])
                         .map(x=>x[1]);
      [myIcon, oppIcon] = [arr[0], arr[1]];
    })();

    let playerIndex=null, myPoison=null, chosen=false;
    const myEaten=new Set(), opEaten=new Set();

    let socket;
    if (typeof io !== "undefined") {
      socket = io({ transports:['websocket'] });

      socket.on('connect', ()=>{
        statusTxt.innerText = 'âœ… å·²è¿æ¥ï¼Œæ­£åœ¨åŠ å…¥æˆ¿é—´â€¦';
        socket.emit('join', { room, size: boardSize });
      });
      socket.on('joined', d => {
        playerIndex = d.playerIndex;
        statusTxt.innerText = `ä½ æ˜¯ç©å®¶ #${playerIndex+1}ï¼Œè¯·å…ˆé€‰å®šæ¯’è¯`;
      });

      // ä¿ç•™åŸæ¥ render ç»‘å®š
      socket.on('update', render);

      // â€”â€” æ–°å¢ï¼šåœ¨ update äº‹ä»¶é‡Œä¼˜å…ˆè¦†ç›–å›¾æ ‡ï¼Œå†æ¸²æŸ“ä¸€æ¬¡ â€”â€” 
      socket.on('update', d => {
        if (d.avatars) {
          myIcon  = d.avatars[playerIndex];
          oppIcon = d.avatars[1 - playerIndex];
        }
        render(d);
      });

      socket.on('error', d => showDialog('âŒ ' + d.msg));
      socket.on('game_over', d => {
        const isWin = socket.id === d.winner;
        showDialog(isWin ? 'ğŸ‰ æœ‰å®åŠ›ï¼Œè½»æ¾æ‹¿ä¸‹' : 'ğŸ’€ èœå°±å¤šç»ƒ', true);
      });
    } else {
      statusTxt.innerText = 'âŒ Socket.IO å®¢æˆ·ç«¯åŠ è½½å¤±è´¥';
      showDialog('ğŸš« æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œå¯èƒ½æœªå¯åŠ¨ Flask æˆ–ç½‘ç»œé—®é¢˜', true);
    }

    function render(g) {
      pool.innerHTML = '';
      g.food.forEach((cell, idx) => {
        const btn = document.createElement('button');
        if (cell === 'ğŸ’‹') {
          btn.textContent = myEaten.has(idx) ? myIcon
                          : opEaten.has(idx) ? oppIcon
                          : 'ğŸ’‹';
        } else {
          btn.textContent = cell;
        }
        btn.onclick = () => move(idx);
        pool.appendChild(btn);
      });
      statusTxt.innerText =
        `æˆ¿é—´ç©å®¶æ•°ï¼š${g.total_players} ï½œ ` +
        (g.turn_idx === playerIndex ? 'è½®åˆ°ä½ ' : 'ç­‰å¾…å¯¹æ‰‹');
    }

    function move(idx) {
      if (!chosen) {
        socket.emit('set_poison', { room, index: idx });
        myPoison  = idx;
        chosen    = true;
        showDialog('âœ… æ¯’è¯å·²è®¾å®šï¼Œç»§ç»­æ¸¸æˆ');
        return;
      }
      if (idx === myPoison) {
        showDialog('âŒ ä¸å¯ä»¥ï¼Œè¿™æ˜¯ä½ è‡ªå·±çš„æ¯’è¯');
        return;
      }
      myEaten.add(idx);
      socket.emit('eat', { room, index: idx });
    }

    function showDialog(msg, withBtn = false) {
      dialogMsg.innerText   = msg;
      dialogBtn.style.display = withBtn ? 'block' : 'none';
      overlay.style.display   = 'flex';
    }
    function hideDialog(e) {
      if (e && e.target !== e.currentTarget) return;
      overlay.style.display = 'none';
    }
  </script>
</body>
</html>
